C51 COMPILER V9.60.7.0   PERMISSION                                                        05/11/2023 11:48:30 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE PERMISSION
OBJECT MODULE PLACED IN .\Objects\permission.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE source\permission.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\driver;.\sou
                    -rce;.\lib) DEBUG OBJECTEXTEND PRINT(.\Listings\permission.lst) OBJECT(.\Objects\permission.obj)

line level    source

   1          #include "permission.h"
   2          #include "norflash.h"
   3          #include <STRING.H>
   4          #include "ui.h"
   5          #include "debug.h"
   6          #include "sys.h"
   7          
   8          PermissionTypeDef aaa = {0};
   9          PermissionTypeDef manager = {0};
  10          PermissionTypeDef admin = {0};
  11          
  12          static uint16_t loginJumpPage;         // 密码登录后跳转的页面
  13          static uint16_t cancelLoginReturnPage; // 取消登录退出页面
  14          
  15          void permissionLogin(void)
  16          {
  17   1          uint16_t userNum;
  18   1          uint8_t passwordEnter[20];
  19   1          uint16_t loginButton;
  20   1          read_dgus_vp(0xAF00, (uint8_t *)&userNum, 1);
  21   1          read_dgus_vp(0xAF02, (uint8_t *)&passwordEnter, 9);
  22   1          read_dgus_vp(0xAF20, (uint8_t *)&loginButton, 1);
  23   1          if (loginButton == 1)
  24   1          {
  25   2              if (userNum == 0) // manager
  26   2              {
  27   3                  Nor_Flash_read(MANAGER_PASSWORD_IN_NORFLASH, manager.password, 10);
  28   3                  // DEBUGINFO("password : %s \n", manager.password);
  29   3                  // DEBUGINFO("password : %s \n", passwordEnter);
  30   3      
  31   3                  {
  32   4                      uint8_t passwordLen;
  33   4                      passwordLen = strpos(passwordEnter, '\xFF');
  34   4      
  35   4                      if (strncmp(manager.password, passwordEnter, passwordLen) == 0)
  36   4                      {
  37   5                          manager.loginFlag = 1;
  38   5                          // DEBUGINFO("%d\n", loginJumpPage);
  39   5                          memset(passwordEnter,0,20);
  40   5                          write_dgus_vp(0xAF02, (uint8_t *)&passwordEnter, 9);
  41   5                          switch (loginJumpPage)
  42   5                          {
  43   6                          case 2:
  44   6                          case 11:
  45   6                          case 22:
  46   6                          case 26:
  47   6                              Page_Change(loginJumpPage);
  48   6                              break;
  49   6      
  50   6                          default:
  51   6                              Page_Change(cancelLoginReturnPage); // 权限不够,返回先前页面
  52   6                              break;
  53   6                          }
  54   5                      }
C51 COMPILER V9.60.7.0   PERMISSION                                                        05/11/2023 11:48:30 PAGE 2   

  55   4                      else
  56   4                      {
  57   5                          Page_Change(105);
  58   5                      }
  59   4                  }
  60   3              }
  61   2              if (userNum == 1) // admin
  62   2              {
  63   3                  Nor_Flash_read(ADMIN_PASSWORD_IN_NORFLASH, admin.password, 10);
  64   3                  {
  65   4                      uint8_t passwordLen;
  66   4                      passwordLen = strpos(passwordEnter, '\xFF');
  67   4      
  68   4                      if (strncmp(admin.password, passwordEnter, passwordLen) == 0)
  69   4                      {
  70   5                          admin.loginFlag = 1;
  71   5                          Page_Change(loginJumpPage);
  72   5                      }
  73   4                      else
  74   4                      {
  75   5                          Page_Change(105);
  76   5                      }
  77   4                  }
  78   3              }
  79   2              loginButton = 0;
  80   2              write_dgus_vp(0xAF20, (uint8_t *)&loginButton, 1);
  81   2          }
  82   1      
  83   1          { // 取消登录
  84   2              uint16_t cancelButton;
  85   2              read_dgus_vp(0xAF22, (uint8_t *)&cancelButton, 1);
  86   2              if (cancelButton == 1)
  87   2              {
  88   3                  Page_Change(cancelLoginReturnPage);
  89   3                  cancelButton = 0;
  90   3                  write_dgus_vp(0xAF22, (uint8_t *)&cancelButton, 1);
  91   3              }
  92   2          }
  93   1      }
  94          
  95          void passwordModify(void)
  96          {
  97   1          uint16_t userNum;
  98   1          uint8_t oldPassword[20] = {0};
  99   1          uint8_t newPassword[20] = {0};
 100   1          uint16_t modifyButton;
 101   1          read_dgus_vp(0xAF50, (uint8_t *)&userNum, 1);
 102   1          read_dgus_vp(0xAF60, (uint8_t *)&oldPassword, 9);
 103   1          read_dgus_vp(0xAF70, (uint8_t *)&newPassword, 9);
 104   1          read_dgus_vp(0xAF80, (uint8_t *)&modifyButton, 1);
 105   1          if (modifyButton == 1)
 106   1          {
 107   2              if (userNum == 0) // manager
 108   2              {
 109   3                  Nor_Flash_read(MANAGER_PASSWORD_IN_NORFLASH, manager.password, 10);
 110   3                  // DEBUGINFO("manager password : %s \n", manager.password);
 111   3                  // DEBUGINFO("oldPassword : %s \n", oldPassword);
 112   3                  {
 113   4                      uint8_t newPasswordLen = strpos(newPassword, '\xFF');
 114   4                      if (newPasswordLen != -1)
 115   4                      {
 116   5                          // DEBUGINFO("newPassword : %s \n", newPassword);
C51 COMPILER V9.60.7.0   PERMISSION                                                        05/11/2023 11:48:30 PAGE 3   

 117   5                          // DEBUGINFO("newPasswordLen = %bd", newPasswordLen);
 118   5                          if (newPasswordLen >= 4)
 119   5                          {
 120   6                              uint8_t oldPasswordLen;
 121   6                              oldPasswordLen = strpos(oldPassword, '\xFF');
 122   6                              if (oldPasswordLen != -1)
 123   6                              {
 124   7                                  if (strncmp(manager.password, oldPassword, oldPasswordLen) == 0)
 125   7                                  {
 126   8                                      Nor_Flash_write(MANAGER_PASSWORD_IN_NORFLASH, newPassword, 10);
 127   8                                      Page_Change(107);
 128   8                                  }
 129   7                                  else
 130   7                                  {
 131   8                                      Page_Change(106);
 132   8                                  }
 133   7                              }
 134   6                          }
 135   5                          else if (newPasswordLen < 4)
 136   5                          {
 137   6                              Page_Change(108);
 138   6                          }
 139   5                      }
 140   4                  }
 141   3              }
 142   2              else if (userNum == 1) // admin
 143   2              {
 144   3                  Nor_Flash_read(ADMIN_PASSWORD_IN_NORFLASH, admin.password, 10);
 145   3                  {
 146   4                      uint8_t newPasswordLen = strpos(newPassword, '\xFF');
 147   4                      if (newPasswordLen != -1)
 148   4                      {
 149   5                          if (newPasswordLen >= 4)
 150   5                          {
 151   6                              uint8_t oldPasswordLen;
 152   6                              oldPasswordLen = strpos(oldPassword, '\xFF');
 153   6                              if (newPassword != -1)
 154   6                              {
 155   7                                  if (strncmp(admin.password, oldPassword, oldPasswordLen) == 0)
 156   7                                  {
 157   8                                      Nor_Flash_write(ADMIN_PASSWORD_IN_NORFLASH, newPassword, 10);
 158   8                                      Page_Change(107);
 159   8                                  }
 160   7                                  else
 161   7                                  {
 162   8                                      Page_Change(106);
 163   8                                  }
 164   7                              }
 165   6                          }
 166   5                          else if (newPasswordLen < 4)
 167   5                          {
 168   6                              Page_Change(108);
 169   6                          }
 170   5                      }
 171   4                  }
 172   3              }
 173   2              modifyButton = 0;
 174   2              write_dgus_vp(0xAF80, (uint8_t *)&modifyButton, 1);
 175   2          }
 176   1      }
 177          
 178          void passwordLogin(uint16_t form_LoginJumpPage)
C51 COMPILER V9.60.7.0   PERMISSION                                                        05/11/2023 11:48:30 PAGE 4   

 179          {
 180   1          loginJumpPage = form_LoginJumpPage;
 181   1          read_dgus_vp(PIC_NOW, (uint8_t *)&cancelLoginReturnPage, 1);
 182   1          Page_Change(PASSWORD_LOGIN_PAGE);
 183   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1070    ----
   CONSTANT SIZE    =     40    ----
   XDATA SIZE       =    127      72
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
