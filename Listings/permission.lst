C51 COMPILER V9.60.7.0   PERMISSION                                                        05/05/2023 17:15:21 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE PERMISSION
OBJECT MODULE PLACED IN .\Objects\permission.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE source\permission.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\driver;.\sou
                    -rce;.\lib) DEBUG OBJECTEXTEND PRINT(.\Listings\permission.lst) OBJECT(.\Objects\permission.obj)

line level    source

   1          #include "permission.h"
   2          #include "norflash.h"
   3          #include <STRING.H>
   4          #include "ui.h"
   5          #include "debug.h"
   6          #include "sys.h"
   7          
   8          PermissionTypeDef aaa = {0};
   9          PermissionTypeDef manager = {0};
  10          PermissionTypeDef admin = {0};
  11          
  12          static uint16_t loginJumpPage;         // 密码登录后跳转的页面
  13          static uint16_t cancelLoginReturnPage; // 取消登录退出页面
  14          
  15          void permissionLogin(void)
  16          {
  17   1          uint16_t userNum;
  18   1          uint8_t passwordEnter[20];
  19   1          uint16_t loginButton;
  20   1          read_dgus_vp(0xAF00, (uint8_t *)&userNum, 1);
  21   1          read_dgus_vp(0xAF02, (uint8_t *)&passwordEnter, 9);
  22   1          read_dgus_vp(0xAF20, (uint8_t *)&loginButton, 1);
  23   1          if (loginButton == 1)
  24   1          {
  25   2              if (userNum == 0) // manager
  26   2              {
  27   3                  Nor_Flash_read(MANAGER_PASSWORD_IN_NORFLASH, manager.password, 10);
  28   3                  // DEBUGINFO("password : %s \n", manager.password);
  29   3                  // DEBUGINFO("password : %s \n", passwordEnter);
  30   3      
  31   3                  {
  32   4                      uint8_t passwordLen;
  33   4                      passwordLen = strpos(passwordEnter, '\xFF');
  34   4      
  35   4                      if (strncmp(manager.password, passwordEnter, passwordLen) == 0)
  36   4                      {
  37   5                          manager.loginFlag = 1;
  38   5                          // DEBUGINFO("%d\n", loginJumpPage);
  39   5                          switch (loginJumpPage)
  40   5                          {
  41   6                          case 2:
  42   6                          case 11:
  43   6                          case 22:
  44   6                          case 26:
  45   6                              Page_Change(loginJumpPage);
  46   6                              break;
  47   6      
  48   6                          default:
  49   6                              Page_Change(cancelLoginReturnPage); // 权限不够,返回先前页面
  50   6                              break;
  51   6                          }
  52   5                      }
  53   4                      else
  54   4                      {
C51 COMPILER V9.60.7.0   PERMISSION                                                        05/05/2023 17:15:21 PAGE 2   

  55   5                          Page_Change(105);
  56   5                      }
  57   4                  }
  58   3              }
  59   2              if (userNum == 1) // admin
  60   2              {
  61   3                  Nor_Flash_read(ADMIN_PASSWORD_IN_NORFLASH, admin.password, 10);
  62   3                  {
  63   4                      uint8_t passwordLen;
  64   4                      passwordLen = strpos(passwordEnter, '\xFF');
  65   4      
  66   4                      if (strncmp(admin.password, passwordEnter, passwordLen) == 0)
  67   4                      {
  68   5                          admin.loginFlag = 1;
  69   5                          Page_Change(loginJumpPage);
  70   5                      }
  71   4                      else
  72   4                      {
  73   5                          Page_Change(105);
  74   5                      }
  75   4                  }
  76   3              }
  77   2              loginButton = 0;
  78   2              write_dgus_vp(0xAF20, (uint8_t *)&loginButton, 1);
  79   2          }
  80   1      
  81   1          { // 取消登录
  82   2              uint16_t cancelButton;
  83   2              read_dgus_vp(0xAF22, (uint8_t *)&cancelButton, 1);
  84   2              if (cancelButton == 1)
  85   2              {
  86   3                  Page_Change(cancelLoginReturnPage);
  87   3                  cancelButton = 0;
  88   3                  write_dgus_vp(0xAF22, (uint8_t *)&cancelButton, 1);
  89   3              }
  90   2          }
  91   1      }
  92          
  93          void passwordModify(void)
  94          {
  95   1          uint16_t userNum;
  96   1          uint8_t oldPassword[20] = {0};
  97   1          uint8_t newPassword[20] = {0};
  98   1          uint16_t modifyButton;
  99   1          read_dgus_vp(0xAF50, (uint8_t *)&userNum, 1);
 100   1          read_dgus_vp(0xAF60, (uint8_t *)&oldPassword, 9);
 101   1          read_dgus_vp(0xAF70, (uint8_t *)&newPassword, 9);
 102   1          read_dgus_vp(0xAF80, (uint8_t *)&modifyButton, 1);
 103   1          if (modifyButton == 1)
 104   1          {
 105   2              if (userNum == 0) // manager
 106   2              {
 107   3                  Nor_Flash_read(MANAGER_PASSWORD_IN_NORFLASH, manager.password, 10);
 108   3                  // DEBUGINFO("manager password : %s \n", manager.password);
 109   3                  // DEBUGINFO("oldPassword : %s \n", oldPassword);
 110   3                  {
 111   4                      uint8_t newPasswordLen = strpos(newPassword, '\xFF');
 112   4                      if (newPasswordLen != -1)
 113   4                      {
 114   5                          // DEBUGINFO("newPassword : %s \n", newPassword);
 115   5                          // DEBUGINFO("newPasswordLen = %bd", newPasswordLen);
 116   5                          if (newPasswordLen >= 4)
C51 COMPILER V9.60.7.0   PERMISSION                                                        05/05/2023 17:15:21 PAGE 3   

 117   5                          {
 118   6                              uint8_t oldPasswordLen;
 119   6                              oldPasswordLen = strpos(oldPassword, '\xFF');
 120   6                              if (oldPasswordLen != -1)
 121   6                              {
 122   7                                  if (strncmp(manager.password, oldPassword, oldPasswordLen) == 0)
 123   7                                  {
 124   8                                      Nor_Flash_write(MANAGER_PASSWORD_IN_NORFLASH, newPassword, 10);
 125   8                                      Page_Change(107);
 126   8                                  }
 127   7                                  else
 128   7                                  {
 129   8                                      Page_Change(106);
 130   8                                  }
 131   7                              }
 132   6                          }
 133   5                          else if (newPasswordLen < 4)
 134   5                          {
 135   6                              Page_Change(108);
 136   6                          }
 137   5                      }
 138   4                  }
 139   3              }
 140   2              else if (userNum == 1) // admin
 141   2              {
 142   3                  Nor_Flash_read(ADMIN_PASSWORD_IN_NORFLASH, admin.password, 10);
 143   3                  {
 144   4                      uint8_t newPasswordLen = strpos(newPassword, '\xFF');
 145   4                      if (newPasswordLen != -1)
 146   4                      {
 147   5                          if (newPasswordLen >= 4)
 148   5                          {
 149   6                              uint8_t oldPasswordLen;
 150   6                              oldPasswordLen = strpos(oldPassword, '\xFF');
 151   6                              if (newPassword != -1)
 152   6                              {
 153   7                                  if (strncmp(admin.password, oldPassword, oldPasswordLen) == 0)
 154   7                                  {
 155   8                                      Nor_Flash_write(ADMIN_PASSWORD_IN_NORFLASH, newPassword, 10);
 156   8                                      Page_Change(107);
 157   8                                  }
 158   7                                  else
 159   7                                  {
 160   8                                      Page_Change(106);
 161   8                                  }
 162   7                              }
 163   6                          }
 164   5                          else if (newPasswordLen < 4)
 165   5                          {
 166   6                              Page_Change(108);
 167   6                          }
 168   5                      }
 169   4                  }
 170   3              }
 171   2              modifyButton = 0;
 172   2              write_dgus_vp(0xAF80, (uint8_t *)&modifyButton, 1);
 173   2          }
 174   1      }
 175          
 176          void passwordLogin(uint16_t form_LoginJumpPage)
 177          {
 178   1          loginJumpPage = form_LoginJumpPage;
C51 COMPILER V9.60.7.0   PERMISSION                                                        05/05/2023 17:15:21 PAGE 4   

 179   1          read_dgus_vp(PIC_NOW, (uint8_t *)&cancelLoginReturnPage, 1);
 180   1          Page_Change(PASSWORD_LOGIN_PAGE);
 181   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1030    ----
   CONSTANT SIZE    =     40    ----
   XDATA SIZE       =    127      72
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
