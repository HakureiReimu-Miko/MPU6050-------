C51 COMPILER V9.60.7.0   IIC                                                               05/04/2023 14:40:18 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\iic.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE driver\iic.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\driver;.\source;.\l
                    -ib) DEBUG OBJECTEXTEND PRINT(.\Listings\iic.lst) OBJECT(.\Objects\iic.obj)

line level    source

   1          #include "sys.h"
   2          #include "iic.h"
   3          #include "rtc.h"
   4          #include "const.h"
   5           
   6          
   7          void  Init_IIc_Interface(IIC_CFG *cfg)
   8          {
   9   1              SetPinOut((cfg->SCLPort&0xf0)>>4,cfg->SCLPort&0x0f);
  10   1              // SetPinOut((cfg->SDAPort&0xf0)>>4,cfg->SDAPort&0x0f);
  11   1      }
  12          
  13          void SetSdaIn(IIC_CFG *cfg) 
  14          { 
  15   1          SetPinIn((cfg->SDAPort&0xf0)>>4,cfg->SDAPort&0x0f);
  16   1      } 
  17          
  18          void SetSdaOut(IIC_CFG *cfg) 
  19          { 
  20   1          SetPinOut((cfg->SDAPort&0xf0)>>4,cfg->SDAPort&0x0f);
  21   1      } 
  22          
  23          u8  GetSdaIn(IIC_CFG *cfg)
  24          {
  25   1              return GetPinIn((cfg->SDAPort&0xf0)>>4,cfg->SDAPort&0x0f);
  26   1      }
  27          
  28          void SdaOutH(IIC_CFG *cfg)     
  29          {
  30   1              PinOutput((cfg->SDAPort&0xf0)>>4,cfg->SDAPort&0x0f,1);
  31   1      }
  32          
  33          void SdaOutL(IIC_CFG *cfg)
  34          {
  35   1              PinOutput((cfg->SDAPort&0xf0)>>4,cfg->SDAPort&0x0f,0);
  36   1      }
  37          
  38          void SckOutH(IIC_CFG *cfg)
  39          {
  40   1              PinOutput((cfg->SCLPort&0xf0)>>4,cfg->SCLPort&0x0f,1);
  41   1      }
  42          
  43          void SckOutL(IIC_CFG *cfg)
  44          {
  45   1              PinOutput((cfg->SCLPort&0xf0)>>4,cfg->SCLPort&0x0f,0);
  46   1      }    
  47          
  48          
  49          void i2cstart(IIC_CFG *cfg) 
  50          { 
  51   1                      SetSdaOut(cfg); 
  52   1                      SdaOutH(cfg); 
  53   1                      SckOutH(cfg); 
  54   1                      delay_us(15); 
C51 COMPILER V9.60.7.0   IIC                                                               05/04/2023 14:40:18 PAGE 2   

  55   1                      SdaOutL(cfg); 
  56   1                      delay_us(15); 
  57   1                      SckOutL(cfg); 
  58   1                      delay_us(15);
  59   1      } 
  60          
  61          void i2cstop(IIC_CFG *cfg) 
  62          { 
  63   1                      SetSdaOut(cfg); 
  64   1                      SdaOutL(cfg); 
  65   1                      SckOutH(cfg); 
  66   1                      delay_us(15); 
  67   1                      SdaOutH(cfg); 
  68   1                      delay_us(15); 
  69   1                      SetSdaIn(cfg);
  70   1      } 
  71          
  72          void mack(IIC_CFG *cfg) 
  73          { 
  74   1                      SetSdaOut(cfg); 
  75   1                      SdaOutL(cfg); 
  76   1                      delay_us(5); 
  77   1                      SckOutH(cfg); 
  78   1                      delay_us(5); 
  79   1                      SckOutL(cfg); 
  80   1                      delay_us(5); 
  81   1      } 
  82          
  83          void mnak(IIC_CFG *cfg) 
  84          { 
  85   1                      SetSdaOut(cfg); 
  86   1                      SdaOutH(cfg); 
  87   1                      delay_us(5); 
  88   1                      SckOutH(cfg); 
  89   1                      delay_us(5); 
  90   1                      SckOutL(cfg); 
  91   1                      delay_us(5);
  92   1      } 
  93          
  94          void cack(IIC_CFG *cfg)
  95          { 
  96   1                      unsigned char i; 
  97   1                      SetSdaIn(cfg); 
  98   1                      SdaOutH(cfg); 
  99   1                      delay_us(5); 
 100   1                      SckOutH(cfg); 
 101   1                      delay_us(5); 
 102   1                      for(i=0;i<50;i++) 
 103   1                      { 
 104   2                              if(!GetSdaIn(cfg)) break; 
 105   2                        delay_us(5);
 106   2                      } 
 107   1                      SckOutL(cfg); 
 108   1                      delay_us(5); 
 109   1                      SetSdaOut(cfg);
 110   1      } 
 111          
 112          //I2C 写入1个字节 
 113          void i2cbw(u8 WData, IIC_CFG *cfg) 
 114          { 
 115   1                      char i; 
 116   1                      SetSdaOut(cfg); 
C51 COMPILER V9.60.7.0   IIC                                                               05/04/2023 14:40:18 PAGE 3   

 117   1                      for(i=0;i<8;i++) 
 118   1                      { 
 119   2                                      if(WData&0x80) SdaOutH(cfg); 
 120   2                                      else SdaOutL(cfg); 
 121   2                                      WData=(WData<<1); 
 122   2                                      delay_us(5); 
 123   2                                      SckOutH(cfg); 
 124   2                                      delay_us(5); 
 125   2                                      SckOutL(cfg); 
 126   2                                      // delay_us(5);
 127   2                      } 
 128   1                      cack(cfg);
 129   1      } 
 130          
 131          //i2c 读取1个字节数据 
 132          u8 i2cbr(IIC_CFG *cfg) 
 133          { 
 134   1                      u8 i; 
 135   1                      u8 RData;               
 136   1                      SetSdaIn(cfg); 
 137   1                      for(i=0;i<8;i++) 
 138   1                      { 
 139   2                                      delay_us(5); 
 140   2                                      SckOutH(cfg); 
 141   2                                      delay_us(5); 
 142   2                                      RData=(RData<<1); 
 143   2                                      if(GetSdaIn(cfg)) 
 144   2                                      RData=RData|0x01; 
 145   2                                      else 
 146   2                                      RData=RData&0xFE; 
 147   2                                      SckOutL(cfg); 
 148   2                                      // delay_us(5); 
 149   2                      } 
 150   1                      return(RData); 
 151   1      } 
 152                  


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    725    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      26
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
